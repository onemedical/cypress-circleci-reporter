{"version":3,"file":"cypress-circleci-reporter.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { create } from 'xmlbuilder2';\nimport Mocha, { Runner, Suite, Test, MochaOptions } from 'mocha';\nimport createStatsCollector from 'mocha/lib/stats-collector';\nimport fs from 'fs';\nimport path from 'path';\nimport crypto from 'crypto';\nimport stripAnsi from 'strip-ansi';\n\nconst {\n  EVENT_RUN_END,\n  EVENT_TEST_FAIL,\n  EVENT_TEST_PASS,\n  EVENT_SUITE_BEGIN,\n} = Runner.constants;\n\n// A subset of invalid characters as defined in http://www.w3.org/TR/xml/#charsets that can occur in e.g. stacktraces\n// regex lifted from https://github.com/MylesBorins/xml-sanitizer/ (licensed MIT)\nconst INVALID_CHARACTERS_REGEX = /[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007f-\\u0084\\u0086-\\u009f\\uD800-\\uDFFF\\uFDD0-\\uFDFF\\uFFFF\\uC008]/g; // eslint-disable-line no-control-regex, max-len\n\nfunction removeInvalidCharacters(input: string) {\n  return input ? input.replace(INVALID_CHARACTERS_REGEX, '') : input;\n}\n\nfunction getClassname(test: Test) {\n  let { parent } = test;\n  const titles = [];\n  while (parent) {\n    if (parent.title) {\n      titles.unshift(parent.title);\n    }\n    parent = parent.parent;\n  }\n  return titles.join('.');\n}\n\nclass CypressCircleCIReporter extends Mocha.reporters.Base {\n  file = '';\n\n  constructor(runner: Runner, options?: MochaOptions) {\n    super(runner, options);\n\n    createStatsCollector(runner);\n    const projectPath: string | undefined = options?.reporterOptions?.project;\n    const resultsDir: string =\n      options?.reporterOptions?.resultsDir || './test_results/cypress';\n    const resultFileName: string =\n      options?.reporterOptions?.resultFileName || 'cypress-[hash]';\n\n    if (resultFileName.indexOf('[hash]') < 0) {\n      throw new Error(`resultFileName must contain '[hash]'`);\n    }\n\n    const resultFilePath = path.join(resultsDir, `${resultFileName}.xml`);\n\n    const root = create({ version: '1.0', encoding: 'UTF-8' }).ele(\n      'testsuite',\n      {\n        name: 'cypress',\n        timestamp: new Date().toISOString().slice(0, -5),\n      }\n    );\n\n    runner.on(EVENT_SUITE_BEGIN, (suite: Suite) => {\n      if (suite.file) {\n        this.file = path.join(projectPath || '', suite.file);\n      }\n    });\n\n    runner.on(EVENT_TEST_PASS, (test: Test) => {\n      root.ele('testcase', this.getTestcaseAttributes(test));\n    });\n\n    runner.on(EVENT_TEST_FAIL, (test: Test, err: any) => {\n      let message = '';\n      if (err.message && typeof err.message.toString === 'function') {\n        message = String(err.message);\n      } else if (typeof err.inspect === 'function') {\n        message = String(err.inspect());\n      }\n\n      const failureMessage = err.stack || message;\n\n      root\n        .ele('testcase', this.getTestcaseAttributes(test))\n        .ele('failure', {\n          message: removeInvalidCharacters(message) || '',\n          type: err.name || '',\n        })\n        .ele({ $: removeInvalidCharacters(failureMessage) });\n    });\n\n    runner.on(EVENT_RUN_END, () => {\n      root.att('time', ((runner.stats?.duration || 0) / 1000).toFixed(4));\n      root.att('tests', String(runner.stats?.tests || 0));\n      root.att('failures', String(runner.stats?.failures || 0));\n      root.att('skipped', String(runner.stats?.pending || 0));\n\n      const xmlText = root.end({ prettyPrint: true }).toString();\n\n      const finalPath = resultFilePath.replace(\n        '[hash]',\n        crypto\n          .createHash('md5')\n          .update(xmlText)\n          .digest('hex')\n      );\n\n      const finalPathDir = path.dirname(finalPath);\n\n      if (!fs.existsSync(finalPathDir)) {\n        fs.mkdirSync(finalPathDir, { recursive: true });\n      }\n      fs.writeFileSync(finalPath, xmlText, 'utf-8');\n    });\n  }\n\n  private getTestcaseAttributes = (test: Test) => {\n    return {\n      name: stripAnsi(test.title),\n      file: this.file,\n      time:\n        typeof test.duration === 'undefined'\n          ? 0\n          : (test.duration / 1000).toFixed(4),\n      classname: stripAnsi(getClassname(test)),\n      line_number: JSON.parse(test.inspect()).invocationDetails.line,\n    };\n  };\n}\n\nexport default CypressCircleCIReporter;\nmodule.exports = CypressCircleCIReporter;\n"],"names":["EVENT_RUN_END","EVENT_TEST_FAIL","EVENT_TEST_PASS","EVENT_SUITE_BEGIN","Runner","constants","INVALID_CHARACTERS_REGEX","removeInvalidCharacters","input","replace","getClassname","test","parent","titles","title","unshift","join","CypressCircleCIReporter","Mocha","reporters","Base","constructor","runner","options","name","stripAnsi","file","time","duration","toFixed","classname","line_number","JSON","parse","inspect","invocationDetails","line","createStatsCollector","projectPath","reporterOptions","project","resultsDir","resultFileName","indexOf","Error","resultFilePath","path","root","create","version","encoding","ele","timestamp","Date","toISOString","slice","on","suite","getTestcaseAttributes","err","message","toString","String","failureMessage","stack","type","$","att","stats","tests","failures","pending","xmlText","end","prettyPrint","finalPath","crypto","createHash","update","digest","finalPathDir","dirname","fs","existsSync","mkdirSync","recursive","writeFileSync","module","exports"],"mappings":"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"}